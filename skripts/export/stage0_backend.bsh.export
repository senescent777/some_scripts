mangle_conf() {
}

mount_img() {
	[ x$1 != x ] || exit 2
	[ x$2 != x ] || exit 2

	if [ -d $2 ]; then
		found=$(cat /proc/mounts | grep $2 | wc -l)

		if [ $found -gt 0 ] ; then
			umount $CONF_source
			exit 4
		else
			mount -o loop,ro $1 $2
		fi

	else
		exit 5
	fi

}

source_n_target() {
	[ x$1 != x ] || exit 2
	[ -d $CONF_source ] || mkdir -p $CONF_source

	if [ -d $1 ]; then
		CONF_source=$1
	else
		if [ -s $base ] ; then
			mount_img $1 $CONF_source
		else
			exit 6
		fi
	fi

	[ -d $CONF_target ] && rm -rf $CONF_target
	mkdir -p $CONF_target

	sleep 1
}

get_devuan() {
	[ -d $CONF_distros_dir ] || sudo mkdir $CONF_distros_dir
	cd $CONF_distros_dir

		wget $CONF_wget_opts $1
	else
		wget $CONF_wget_opts --recursive $CONF_wget_def_url
	fi


	sha256sum -c SHA256SUMS
	[ $? -eq 0 ] || echo "https://www.youtube.com/watch?v=PjotFePip2M"
}

make_dirs() {
	echo "mkdir $CONF_keys_dir"
	echo "mkdir $CONF_distros_dir"
	echo "mkdir $CONF_bloader"
	echo "mkdir ./grub"
	echo "mkdir $CONF_pkgsdir2"
	echo "mkdir ./v"
}

cleanup() {
	found=$(cat /proc/mounts | grep $CONF_source | wc -l)
	[ $found -eq 0 ] || umount $CONF_source
}

bootloader() {
	ks2="."
	[ x$1 != x ] || exit 2
	[ x$2 != x ] || exit 2
	[ x$CONF_target != x ] || exit 3
	[ -d $CONF_target ] || exit 3

	if [ -s $3/SAM.1 ] ; then
		echo "$3/SAM.1 already exists"
	fi

	cd $CONF_target;pwd

	case $1 in
		isolinux)
			cp -a $CONF_source/isolinux/ . || exit 8

			if [ -d $2/../isolinux ] ; then 
				ks2=$2/../isolinux
				cp -a $ks2/isolinux/*.cfg ./isolinux || exit 9
			fi

			if [ ! -s $3/SAM.1 ] ; then
				griffindor
			fi
		;;
		grub)
			cp -a $CONF_source/boot/ $CONF_target || exit 8
			
			if [ -d $2/../boot ] ; then 
				ks2=$2/../boot
			
				echo "cp -a $ks2/boot/grub/{*.cfg,*.png} ./boot/grub"
				echo "cp -a $ks2/boot/grub/x86_64-efi/{*.cfg,*.png} ./boot/grub/x86_64-efi"	
			fi

			if [ ! -s $3/SAM.1 ] ; then 
				malfoy $TARGET_DIGESTS_dir/SAM.1
			fi
		;;
		*)
			echo "https://www.youtube.com/watch?v=PjotFePip2M"
			exit 11
		;;
	esac

}

copy_main() {

	[ x$1 != x ] || exit 2

	cp -a $CONF_scripts_dir/*.sh $CONF_tmpdir
	chmod 0555 $CONF_tmpdir/*.sh
	sudo chown root:root $CONF_tmpdir/*.sh

	[ -d $CONF_target/$TARGET_DIGESTS_dir ] || mkdir -p $CONF_target/$TARGET_DIGESTS_dir

	cp -a $1/*.sh $2 
	chmod 0555 $2/*.sh 
	sudo chown root:root $2/*.sh

	cd $sorsa 

	if [ -s $1/0/SAM.2.0 ] ; then 
		cp $1/0/SAM.2.0 $1/0/SAM.2 

		cd $1/..
		sha512sum $TARGET_pad_dir/*.sh >> $TARGET_DIGESTS_dir/SAM.2
	fi

		echo "done"
		echo "TARGET_arch1v3s;"
	
	cd $sorsa

		cp -a $1/*.bz2 $2

		cp -a $1/*.bz3 $2 

	chmod 0444 $2/*.bz2
	sudo chown root:root $2/*.bz2
	chmod 0444 $2/*.bz3
	sudo chown root:root $2/*.bz3
	
	sleep 1
}

copy_conf() {

	[ x$1 != x ] || exit 2
	[ x$2 != x ] || exit 2

	cp -a $CONF_scripts_dir/*.conf $CONF_tmpdir 
	cd $sorsa

	cp -a $1/$2.conf $3

	if [ -s $3/upload.sh ] || [ -s $3/extras.tar.bz2 ] ; then 
		for f in $CONF_g2 ; do mangle_conf $f $3/$2.conf ; done
	fi


	utfile=$3/$2.conf
	for f in $CONF_g1; do mangle_conf $f $utfile ; done

	echo -n "src=/" >> $utfile
	echo -n "$" >> $utfile
	echo "TARGET_pad2" >> $utfile
	
	echo -n "tmpdir=" >> $utfile
	echo -n "$" >> $utfile
	echo "TARGET_tmpdir" >> $utfile

	echo -n "pkgdir=" >> $utfile
	echo -n "$" >> $utfile
	echo "TARGET_pkgdir" >> $utfile

	mangle_conf to_ram $utfile
	mangle_conf nosu_do $utfile

	chmod 0444 $3/*.conf
	sudo chown root:root $3/*.conf

	sleep 1



}

copy_sums() {
	[ x$1 != x ] || exit 2

	if [ -d $2 ] ; then
		echo "targeTdir alr3ady ex1st5"
	else
		mkdir $2
		sleep 5
	fi

	cd $sorsa

	if [ -s $1/0/SAM.1 ] ; then


		cp $1/0/SAM.1 $2
	fi

	
	if [ -s $1/0/SAM.2.0 ] ; then
		echo "cp $1/0/SAM.2.0 $2";sleep 1
		cp $1/0/SAM.2.0 $2;sleep 5
	fi

	if [ -s $1/0/SAM.2 ] ; then
		cp $1/0/SAM.2 $2;sleep 5

	fi





}

keyz() {

	[ x$1 != x ] || exit 2

	cp $1/$TARGET_Dkname1 $2

	cp $1/$TARGET_Dkname2 $2
	chmod o+w $2

		echo "CONTENTS OV $2 :"
		ls -las $2;sleep 10
		echo "EXIT keyz()"
}

live1() {

	[ x$1 != x ] || exit 2
	[ x$2 != x ] || exit 2
	cd $1	

	if [ -s ./filesystem.squashfs ] ; then 
		sudo rm $2/filesystem.squashfs
		sleep 5
		sudo cp ./filesystem.squashfs $2	
	else
		sudo cp $CONF_source/live/filesystem.squashfs $2
	fi

}

live2()  {
	[ x$1 != x ] || exit 2
	[ x$2 != x ] || exit 2
	cd $1	

	if [ -s ./vmlinuz ] ; then 
		sudo cp ./vmlinuz $2
	else
		sudo cp $CONF_source/live/vmlinuz $2
	fi
}

live3() {
	[ x$1 != x ] || exit 2
	[ x$2 != x ] || exit 2
	cd $1	

	if [ -s ./initrd.img ] ; then 
		sudo cp ./initrd.img $2
	else
		sudo cp $CONF_source/live/initrd.img $2
	fi
}
